##
# Set the directory where the database will be stored
database: /var/lib/maddash/ 

##
# Set the number of jobs that can run in parallel. Default is 20.
#jobThreadPoolSize: 20

##
# Set number of jobs that can be in queue at one time. Default is 250.
#jobBatchSize: 250

###
# Disable the job scheduler if you only want to run the REST server
#disableScheduler: 0

###
# Skips table and index rebuild at start-up. It can speed up start-up time if set to 1.
#skipTableBuild: 0

##
# Set the host where the REST server listens
serverHost: "localhost"

##
# Activate http and set the port where it listens
http: 
    port: 8881

# notifications:
#    - 
#      ##
#      #This will be the email subject
#      name: "My Email Report"
#      ##
#      #This indicates this is an email notification, currently the only supported type
#      type: "email"
#      ##
#      # A cron schedule in 'MIN HOUR DAY-OF-MONTH MONTH DAY-OF-WEEK' format."
#      # the example runs every hour on the hour. Only sends email if new problem found
#      schedule: "0 * * * ?"
#      ##
#      #Frequency with which to report the same problem. Example below will report a problem
#      #  again only if it still exists after 24 hours.
#      problemReportFrequency: 86400
#      ##
#      #The minimum severity a problem must be where 0=OK, 1=Warning, 2=Critical
#      minimumSeverity: 1
#      ##
#      # parameters specific to email
#      parameters:
#        ##
#        # The main address of your dashboard used to create links in email.
#        dashboardUrl: "http://dashboard.domain.example"
#        ##
#        # information about the mail server. If not set will use localhost port 25 with 
#        # no auth or SSL
#        mailServer:
#            address: "localhost"
#            port: 25
#        ##
#        # Set from address in mailed reports
#        from: "dashboard@domain.example"
#        ##
#        # Set list of to addresses in mailed reports
#        to:
#            - "email1@domain.example"
#            - "email2@domain.example"

##
# Activate https and set port and keystores
#https:
#    port: 8882
#    keystore: "/usr/lib/maddash/maddash-webui/etc/maddash.jks"
#    keystorePassword: "changeit"
# want, require or off
#    clientAuth: "want" 

##
# 'groups' are where you define lists of hosts. You need to provide the name of the group 
# and the list of the hosts in that group. The default example below defines two groups:
# "myOwampHosts" and "myThroughputHosts". You can define any number of other groups and give them
# any alphanumeric name. A host may belong to multiple groups.
groups:
    myOwampHosts :
        - "albq-owamp.es.net"
        - "bois-owamp.es.net"
        - "bost-owamp.es.net"
        - "chic-owamp.es.net"
        - "nettest.lbl.gov"
        
    myThroughputHosts :
        - "albq-pt1.es.net"
        - "bois-pt1.es.net"
        - "bost-pt1.es.net"
        - "chic-pt1.es.net"
        - "nettest.lbl.gov"

##
# 'groupMembers' allow you to assign special properties to items in 'groups': 
#     - Set the "id" to the value used in the "group" list. This is required.
#     - Set the "label" to the name  you want displayed. This block 
#         is useful in cases where you want  a value such as an IP address or port 
#         number passed to a check but on the GUI you want a human-readable value displayed
#     - Set the "pstoolkiturl" to the URL of a perfSONAR Toolkit web page
#     - Map to create special mapped template variables dependent on the opposing row or column
#     - Any custom value accessible in template variables %row.<prop> and %col.<prop> respectively
groupMembers:
    - added_by_psconfig: 1 # remove this if you want to keep after psconfig runs
      id: "chic-pt1.es.net"
      label: "Chicago Tester" 
    - id: "nettest.lbl.gov"
      added_by_psconfig: 1 # remove this if you want to keep after psconfig runs
      label: "LBL Toolkit"
      pstoolkiturl: "http://nettest.lbl.gov/toolkit" 
      # The special map property can be used to create template variables that change depending on opposing row or column
      # For example we could use %row.map.ip in a command to tell nettest.lbl.gov to use ip 10.0.1.1 when every the column is 
      # albq-pt1.es.net and 131.243.24.11 for anything else (default is a special key). The parameter name is freeform and "ip"
      # is just an example
      #map:
      #"albq-pt1.es.net":
      #      ip: "10.0.1.1"
      #  "default":
      #      ip: "131.243.24.11"
##

##
# 'checks' are where you define a template for a check to execute. You'll provide a 
#  command to run, 
checks:
    # Below defines a check that alarms against the loss between the row and column host.
    # It looks at data for the last 30 minutes and runs every 30 minutes. It will go 
    # critical if there is any loss. There is no warning level.
    owampLossCheck :
        added_by_psconfig: 1 # remove this if you want to keep after psconfig runs
        #A descriptive name of the check
        name: "Loss"
        #A description of the check
        description: "Loss from %row to %col (according to %row MA)"
        #Example using mapped variables
        #description: "Loss from %row.map.ip to %col.map.ip (according to %row MA)"
        #The type of check. Other valid values are net.es.maddash.checks.NagiosCheck and
        # net.es.maddash.checks.RandomCheck.
        type: "net.es.maddash.checks.PSNagiosCheck"
        params:
            #The URL of the measurement archive. You can define templates on a per host 
            #basis here. If not defined explicitly the 'default' template will be used.
            maUrl: 
                default: "https://%row/esmond/perfsonar/archive"
            # The section below sets a different maURL for every column in the row albq-owamp.es.net
            #   albq-owamp.es.net:
            #       default: "https://%col/esmond/perfsonar/archive"     
            # The section below sets a different maURL for every column in the row 
            # bois-owamp.es.net EXCEPT the column bost-owamp.es.net
            #   bois-owamp.es.net:
            #       default: "https://%col/esmond/perfsonar/archive"  
            #       bost-owamp.es.net: "https://%row/esmond/perfsonar/archive"
            # The section below sets a different maURL for the check at row bost-owamp.es.net 
            # and column albq-owamp.es.net
            #   bost-owamp.es.net:
            #       albq-owamp.es.net: "https://perfsonar-archive.es.net/esmond/perfsonar/archive"
            #
            #DEPRECATED: It looks up all the 'keys' the 
            #node associates with a particular source/destination regardless of 
            #whether IP or hostname is used. In general you should just be able to change 
            #the hostname in the URL (example.mydomain.local),  to the name of your toolkit host 
            #and it will work. You can leave the rest of the URL untouched.
            #metaDataKeyLookup: "https://example.mydomain.local/perfsonar-graphs/metaKeyReq.cgi?ma_url=%maUrl&eventType=%event.delayBuckets&srcRaw=%row&dstRaw=%col&count=0&bucket_width=0"
            #This is the URL to the graph script. You should be able to change the 
            #hostname(example.mydomain.local) to your toolkit hostname and leave the rest of the 
            #URL untouched. 
            graphUrl: "https://example.mydomain.local/perfsonar-graphs/?url=%maUrl&dest=%col&source=%row"
            #The Nagios command to execute. The -w and -c options define the thresholds. 
            #The -r option specifies the time range to query.
            command: "/usr/lib64/nagios/plugins/check_owdelay.pl -u %maUrl -w 0 -c 0 -r 1800 -l -p -s %row -d %col"
        #How often to run the check (in seconds)
        checkInterval: 1800
        #How often to run the check if it detects a state different than the previous 
        #state. For example, if a check has been OK for 3 days, but suddenly a critical 
        #is seen, it will try again in this number of seconds rather than waiting the full 
        #interval
        retryInterval: 300
        #The number of consecutive times a new state must be seen before it changes the 
        #color in a grid. For example, if a check has been OK for 3 days, but suddenly a 
        #critical is seen, It must be seen 2 more times before the color will change
        retryAttempts: 3
        #The maximum number of seconds a command will be allowed to run
        timeout: 60
    
    # Below defines a check that alarms against the loss between the column and row host. 
    # It just swaps the source and destination of the other OWAMP check to get data for 
    # the reverse direction. The parameters have the same meaning as the previous example
    owampLossRevCheck :
        added_by_psconfig: 1 # remove this if you want to keep after psconfig runs
        name: "Loss Reverse"
        description: "Loss from %col to %row (according to %row MA)"
        type: "net.es.maddash.checks.PSNagiosCheck"
        params:
            maUrl: 
                default: "https://%row/esmond/perfsonar/archive"
            graphUrl: "https://example.mydomain.local/perfsonar-graphs/?url=%maUrl&dest=%row&source=%col"
            command: "/usr/lib64/nagios/plugins/check_owdelay.pl -u %maUrl -w 0 -c 0 -r 900 -l -p -s %col -d %row"
        checkInterval: 1800
        retryInterval: 300
        retryAttempts: 3
        timeout: 60
    
    # Below defines a check that alarms on throughput reported by Throughput from the row host 
    # to the column host. It runs every 8 hours. It alarms on average throughput for the 
    # last 24 hours. It will go to the warning (yellow) level if throughput drops below 
    # 100Mbps. It goes to critical if it drops below 10Mbps. Adjust the 'command' 
    # parameter's -w property to change the warning level and -c parameter to change the 
    # critical level. All units are in Gbps (e.g. .1 = 100Mbps).
    throughputCheck :
        added_by_psconfig: 1 # remove this if you want to keep after psconfig runs
        name: "Throughput"
        description: "Throughput from %row to %col (according to %row MA)"
        type: "net.es.maddash.checks.PSNagiosCheck"
        params:
            maUrl:
                default: "https://%row/esmond/perfsonar/archive"
            graphUrl: "https://example.mydomain.local/perfsonar-graphs/?url=%maUrl&dest=%col&source=%row"
            #Adjust the -w and -c values to adjust the thresholds. The thresholds are specified in Gbps.
            command:  "/usr/lib64/nagios/plugins/check_throughput.pl -u %maUrl -w .1: -c .01: -r 86400 -s %row -d %col"
        checkInterval: 28800
        retryInterval: 600
        retryAttempts: 3
        timeout: 60
    
    # Same as the Throughput check above but tests in the reverse direction (from the column 
    # host to the row host).
    throughputRevCheck :
        added_by_psconfig: 1 # remove this if you want to keep after psconfig runs
        name: "Throughput Reverse"
        description: "Throughput from %col to %row (according to %row MA)"
        type: "net.es.maddash.checks.PSNagiosCheck"
        params:
            maUrl:
                default: "https://%row/esmond/perfsonar/archive"
            graphUrl: "https://example.mydomain.local/perfsonar-graphs/?url=%maUrl&dest=%row&source=%col"
            #Adjust the -w and -c values to adjust the thresholds. The thresholds are specified in Gbps.
            command:  "/usr/lib64/nagios/plugins/check_throughput.pl -u %maUrl -w .1: -c .01: -r 86400 -s %col -d %row"
        checkInterval: 28800
        retryInterval: 600
        retryAttempts: 3
        timeout: 60

#'grids' are where you define the two dimensional tables that get displayed. You specify 
# which host 'groups' will compose the rows and columns and the 'checks' you want run. You also
# provide some descriptive information that will be displayed
grids:
      #The first item in the list is a grid for the loss checks between the OWAMP hosts
      # defined. The first property "name" defines the title that will display on the dashboard.
    - name: "OWAMP"
      added_by_psconfig: 1 # remove this if you want to keep after psconfig runs
      # Define the hosts that will be listed down the left side of the grid. This MUST be a 
      # value defined in the 'groups' section of this config file.
      rows: "myOwampHosts"
      # Define the hosts that will be listed across the top of the grid. This MUST be a 
      # value defined in the 'groups' section of this config file. It can be the same or 
      # a different group from teh one defined in 'rows'.
      columns: "myOwampHosts"
      #Define the checks that will be shown in each cell in the grid. You may define up 
      # to 2. If there are more than one the top half of the cell will be the first check 
      # listed and the bottom half will be the second. This is often useful for showing 
      # results in the different directions.
      checks: 
        - "owampLossCheck"
        - "owampLossRevCheck"
      #Specify the order you want hosts assigned to the 'rows' attribute to be displayed.
      # Valid values are as follows:
      #   alphabetical - automatically sorts members of the group alphabetically
      #   group - displays the members of the group exactly in the order they are defined
      rowOrder: "alphabetical"
      #Specify the order you want hosts assigned to the 'cols' attribute to be displayed.
      # Valid values are as follows:
      #   alphabetical - automatically sorts members of the group alphabetically
      #   group - displays the members of the group exactly in the order they are defined
      colOrder: "alphabetical"
      # Set to  if you don't want results to be checked from a host to itself. Set to 0 
      # otherwise.
      excludeSelf: 1
      # The section below allows you to exclude individual checks. The structure is a map
      # where the key is the name of the row where you want to exclude a check. It should match
      # a member of the group assigned to the "rows" property of this grid or it can be the special
      # key 'default' that matches every row. The value is a list of columns that should not appear 
      # in the grid. An item in the list must be a member of the group assigned to the "columns"
      # property of this grid or the special value "all" which removes all columns for a row. The example
      # below does the following:
      #     * Excludes the column albq-pt1.es.net from every row 
      #     * Excludes the column chic-pt1.es.net from the row bois-owamp.es.net
      #     * Excludes every column in the row bost-owamp.es.net
      # excludeChecks:
      #  default:
      #      - "albq-pt1.es.net"
      #  bois-owamp.es.net: 
      #      - "chic-pt1.es.net"
      #  bost-owamp.es.net:
      #      - "all"
      #
      # Determines which checks will be run. Valid values are as follows:
      #  all - Run a check between every row and column. This will be the most common.
      #  afterSelf - Run a check to every host that's defined after the current row in the 'rows' group
      #  beforeSelf - Run a check to every host that's defined before the current row in the 'rows' group
      columnAlgorithm: "all" 
      # Reference a report (see the further down in this file) to apply to this grid
      report: "loss_mesh_report"
      # 'statusLabels' is where you provide a human-readable description of what each 
      #  threshold means. These are the values that will be displayed in the legend. If a 
      #  threshold is not defined below then that will not be displayed in the legend. 
      #  Valid values are as follows:
      #     ok: corresponds to the green status.
      #     warning: the yellow status.
      #     critical: the red status.
      #     unknown: the orange status
      #     notrun: the gray status. means the check has not run yet. should only happen first time check deployed.
      statusLabels:
            ok: "Loss is 0"
            critical: "Loss is greater than 0"
            unknown: "Unable to retrieve data"
            notrun: "Check has not yet run"
            #note: 'warning' not defined because no warning threshold set
    #Below is a second grid that defines the throughput checks to the Throughput hosts defined.
    # The parameters have the same meaning as the OWAMP check above so they are not repeated here.
    - name: "Throughput"
      added_by_psconfig: 1 # remove this if you want to keep after psconfig runs
      rows: "myThroughputHosts"
      columns: "myThroughputHosts"
      checks: 
        - "throughputCheck"
        - "throughputRevCheck"
      rowOrder: "alphabetical"
      colOrder: "alphabetical"
      excludeSelf: 1
      columnAlgorithm: "all" 
      report: "throughput_mesh_report"
      statusLabels:
            ok: "Throughput >= 100Mbps"
            warning: "Throughput >= 10Mbps"
            critical: "Throughput < 10Mbps"
            unknown: "Unable to retrieve data"
            notrun: "Check has not yet run"
            #we can define a additional states here. A common one is the "scheduled even state" supported by the admin UI.
            extra:
                - value: 5
                  shortName: EVENT
                  description: "Down for maintenance"
                     
                    

#'dashboards' provide a way to group grids together. Grids grouped in this manner will
# be displayed on the same page together. This is a list, so you can define as many 
# dashboards as you want.
dashboards:
    #The following defines a dashboard that shows the Throughput and OWAMP results on the same 
    # page. The 'name' parameter defines the title that will displayed on the dashboard
    - name: "My Sites"
      added_by_psconfig: 1 # remove this if you want to keep after psconfig runs
      # Defines the list of grids that belong to this dashboard. Each 'name' must 
      # correspond to the name defined under the 'grids' sections of this config file. 
      grids:
        - name: "OWAMP"
        - name: "Throughput"

#'reports' provide a way to define patterns that can be used to alert on certain types of problems
# Since every dashboard is different, reports provide a flexible way to define patterns
#defaultReport: "grid_up_down_report"
reports:
    -
        id: "grid_up_down_report"
        added_by_psconfig: 1 # remove this if you want to keep after psconfig runs
        rule:
            type: matchFirst
            rules:
                - 
                    type: rule
                    selector:
                        type: grid
                    match:
                        type: status
                        status: 3
                    problem:
                        severity: 3
                        category: CONFIGURATION
                        message: "Grid is down" 
                        solutions:
                            - "Check your maddash configuration"
                - 
                    type: rule
                    selector:
                        type: grid
                    match:
                        type: status
                        status: 0
                    problem:
                        severity: 0
                        category: CONFIGURATION
                        message: "No issues found"
    -
        id: "throughput_mesh_report"
        added_by_psconfig: 1 # remove this if you want to keep after psconfig runs
        rule:
            type: matchFirst
            rules:
                - 
                    type: rule
                    selector:
                        type: grid
                    match:
                        type: status
                        status: 3
                    problem:
                        severity: 3
                        category: CONFIGURATION
                        message: "Grid is down" 
                        solutions:
                            - "If you just configured this grid in the configuration, you may just need to wait as it takes several hours for throughput data to populate (depending on the interval between tests)"
                            - "Verify maddash is configured properly. Look in the files under /var/log/maddash/ for any errors. Things to look for are incorrect paths to checks or connection errors."
                            - "Verify that pSConfig MaDDash Agent has run recently and you are looking at an accurate test configuration"                            
                            - "Verify that your measurement archive(s) are running"
                            - "Verify no firewall is blocking maddash from reaching your measurement archive(s)"
                            - "Verify your hosts are downloading the pSConfig file and that there are tasks defined in command 'psconfig pscheduler-tasks'"
                            - "Verify that psconfig-pscheduler-agent is running ('systemctl status psconfig-pscheduler-agent')"
                            - "Verify your hosts are able to reach their configured measurement archive and that there are no errors in /var/log/perfsonar/psconfig-pscheduler-agent.log"                            
                - 
                    type: rule
                    selector:
                        type: grid
                    match:
                        type: status
                        status: 0
                    problem:
                        severity: 0
                        category: PERFORMANCE
                        message: "Entire grid has OK status."
                - 
                    type: forEachSite
                    rule:
                        type: matchFirst
                        rules:
                            - 
                                type: rule
                                selector:
                                    type: site
                                match:
                                    type: status
                                    status: 3                        
                                problem:
                                    severity: 3
                                    category: CONFIGURATION
                                    message: "Site is down"
                                    solutions:
                                        - "Verify the host is up"
                                        - "If recently added to the configuration, verify the pSConfig file has been downloaded by the end-hosts since the update. It may also take several hours for the first throughput test to run on this host."
                                        - "If recently removed from the configuration, verify that the pSConfig MaDDash Agent has run recently and you are looking at an accurate test configuration"
                                        - "Verify NTP is synced on this host" 
                                        - "Verify the local and remote sites allow access to TCP port 443 and TCP/UDP port 5201"                           
                            - 
                                type: rule
                                selector:
                                    type: row
                                match:
                                    type: status
                                    status: 3                        
                                problem:
                                    severity: 3
                                    category: CONFIGURATION
                                    message: "Unable to run and/or query any outgoing throughput tests."
                                    solutions:
                                        - "Verify you are not blocking any of the required outgoing throughput ports in your firewall"
                                        - "Verify the remote sites allow your host to access TCP port 443 and TCP/UDP port 5201"
                                        - "Verify the limits defined in /etc/pscheduler/limits.conf on each side are properly defined and not being exceeded by the tests"
                            - 
                                type: rule
                                selector:
                                    type: column
                                match:
                                    type: status
                                    status: 3                        
                                problem:
                                    severity: 3
                                    category: CONFIGURATION
                                    message: "Unable to run and/or query any incoming throughput tests."
                                    solutions:
                                        - "Verify your host and router firewalls are allowing TCP port 443 and TCP/UDP port 5201"
                                        - "Verify the limits defined in /etc/pscheduler/limits.conf are properly defined and not being exceeded by the tests"
                            - 
                                type: matchAll
                                rules:
                                    -
                                        type: rule
                                        selector:
                                            type: row
                                        match:
                                            type: statusWeightedThreshold
                                            statuses: 
                                                - 0.0
                                                - .5
                                                - 1.0
                                                - -1.0
                                            threshold: .6
                                        problem:
                                            severity: 2
                                            category: PERFORMANCE
                                            message: "Outgoing throughput is below warning or critical thresholds to a majority of sites"
                                    - 
                                        type: rule
                                        selector:
                                            type: column
                                        match:
                                            type: statusWeightedThreshold
                                            statuses: 
                                                - 0.0
                                                - .5
                                                - 1.0
                                                - -1.0
                                            threshold: .6
                                        problem:
                                            severity: 2
                                            category: PERFORMANCE
                                            message: "Incoming throughput is below warning or critical thresholds to a majority of sites"
    -
        id: "loss_mesh_report"
        rule:
            type: matchFirst
            rules:
                - 
                    type: rule
                    selector:
                        type: grid
                    match:
                        type: status
                        status: 3
                    problem:
                        severity: 3
                        category: CONFIGURATION
                        message: "Grid is down" 
                        solutions:
                            - "If you just configured this grid, you may just need to wait as it takes a few minutes for loss data to populate"
                            - "Verify maddash is configured properly. Look in the files under /var/log/maddash/ for any errors. Things to look for are incorrect paths to checks or connection errors."
                            - "Verify that the pSConfig MaDDash Agent has run recently and you are looking at an accurate test configuration"                            
                            - "Verify that your measurement archive(s) are running"
                            - "Verify no firewall is blocking maddash from reaching your measurement archive(s)"
                            - "Verify your hosts are downloading the pSConfig file and that there are tasks listed when you run 'psconfig pscheduler-tasks'"
                            - "Verify that pSConfig pScheduler Agent is running ('systemctl status psconfig-pscheduler-agent')"
                            - "Verify your hosts are able to reach their configured measurement archive and that there are no errors in /var/log/perfsonar/psconfig-pscheduler-agent.log"                            
                - 
                    type: rule
                    selector:
                        type: grid
                    match:
                        type: status
                        status: 0
                    problem:
                        severity: 0
                        category: PERFORMANCE
                        message: "Entire grid has OK status"
                - 
                    type: forEachSite
                    rule:
                        type: matchFirst
                        rules:
                            - 
                                type: rule
                                selector:
                                    type: site
                                match:
                                    type: status
                                    status: 3                        
                                problem:
                                    severity: 3
                                    category: CONFIGURATION
                                    message: "Site is down"
                                    solutions:
                                        - "Verify the host is up"
                                        - "If recently added to the configuration, verify the pSConfig file has been downloaded by the end-hosts since the update."
                                        - "If recently removed from the configuration, verify that the pSConfig MaDDash Agent has run recently and you are looking at an accurate test configuration"
                                        - "Verify the local and remote sites allow access to TCP port 861 and UDP ports 8760-9960"                           
                            - 
                                type: rule
                                selector:
                                    type: row
                                match:
                                    type: status
                                    status: 3                        
                                problem:
                                    severity: 3
                                    category: CONFIGURATION
                                    message: "Unable to run and/or query any outgoing one-way delay tests."
                                    solutions:
                                        - "Verify you are not blocking any of the required outgoing OWAMP ports in your firewall"
                                        - "Verify the remote sites allow your host to access UDP ports 8760-9960"
                            - 
                                type: rule
                                selector:
                                    type: column
                                match:
                                    type: status
                                    status: 3                        
                                problem:
                                    severity: 3
                                    category: CONFIGURATION
                                    message: "Unable to run and/or query any incoming one-way delay tests."
                                    solutions:
                                        - "Verify your host and router firewalls are allowing UDP ports 8760-9960"
                            - 
                                type: matchAll
                                rules:
                                    -
                                        type: rule
                                        selector:
                                            type: row
                                        match:
                                            type: statusWeightedThreshold
                                            statuses: 
                                                - 0.0
                                                - .5
                                                - 1.0
                                                - -1.0
                                            threshold: .6
                                        problem:
                                            severity: 2
                                            category: PERFORMANCE
                                            message: "Outgoing loss is above warning or critical thresholds to a majority of sites"
                                    - 
                                        type: rule
                                        selector:
                                            type: column
                                        match:
                                            type: statusWeightedThreshold
                                            statuses: 
                                                - 0.0
                                                - .5
                                                - 1.0
                                                - -1.0
                                            threshold: .6
                                        problem:
                                            severity: 2
                                            category: PERFORMANCE
                                            message: "Incoming loss is above warning or critical thresholds to a majority of sites"
